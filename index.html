import React, { useState, useEffect } from 'react';
import { Box, Button, Checkbox, FormControlLabel } from '@mui/material';
import './App.css';

function App() {
  const [map, setMap] = useState(null);
  const [activeFilters, setActiveFilters] = useState([]);
  const [activeLocTypes, setActiveLocTypes] = useState([]);
  const [markers, setMarkers] = useState([]);
  const [showFilterContainer, setShowFilterContainer] = useState(false);
  const [showNewFilterContainer, setShowNewFilterContainer] = useState(false);

  useEffect(() => {
    initMap();
  }, []);

  const initMap = () => {
    const initPosition = "56.871009248911655,-72.62568359375001";
    const [lat, lng] = initPosition.split(',').map(Number);

    const mapInstance = new google.maps.Map(document.getElementById('map'), {
      center: { lat, lng },
      zoom: 6,
      streetViewControl: false,
      mapTypeControl: false,
      disableDefaultUI: true,
      backgroundColor: '#1E2026',
    });

    setMap(mapInstance);

    // Assume markers data is available as an array of objects with properties like `lat`, `lng`, `category_id`, etc.
    // Example:
    const markersData = [
      { lat: 56.871, lng: -72.626, category_id: '1', loc_type: '2' },
      // More marker data...
    ];

    const initialMarkers = markersData.map((data) => {
      const marker = new google.maps.Marker({
        position: { lat: data.lat, lng: data.lng },
        map: mapInstance,
        category: data.category_id,
        loc_type: data.loc_type,
      });
      return marker;
    });

    setMarkers(initialMarkers);
  };

  const updateActiveFilters = (filter, isLocType = false) => {
    if (isLocType) {
      // Handle loc_type filters
      setActiveLocTypes((prevLocTypes) => {
        if (prevLocTypes.includes(filter)) {
          return prevLocTypes.filter((type) => type !== filter);
        } else {
          return [...prevLocTypes, filter];
        }
      });
    } else {
      // Handle category filters
      setActiveFilters((prevFilters) => {
        if (filter === 'all') {
          return [];
        }
        if (prevFilters.includes(filter)) {
          return prevFilters.filter((f) => f !== filter);
        } else {
          return [...prevFilters, filter];
        }
      });
    }

    filterMarkers();
  };

  const filterMarkers = () => {
    markers.forEach((marker) => {
      const categoryMatch =
        activeFilters.length === 0 ||
        activeFilters.includes(marker.category);

      const locTypeMatch =
        activeLocTypes.length === 0 ||
        activeLocTypes.includes(marker.loc_type);

      if (categoryMatch && locTypeMatch) {
        marker.setMap(map);
      } else {
        marker.setMap(null);
      }
    });
  };

  const toggleFilterContainer = () => {
    setShowFilterContainer(!showFilterContainer);
  };

  const toggleNewFilterContainer = () => {
    setShowNewFilterContainer(!showNewFilterContainer);
  };

  return (
    <Box className="App">
      <Box id="map"></Box>
      <ToggleButton onClick={toggleFilterContainer} position="80%" icon="icons/toggle_btn.png" />
      <ToggleButton onClick={toggleNewFilterContainer} position="70%" icon="icons/toggle_btn.png" />

      {showFilterContainer && (
        <FilterContainer
          activeFilters={activeFilters}
          updateActiveFilters={(filter) => updateActiveFilters(filter, false)}
        />
      )}

      {showNewFilterContainer && (
        <NewFilterContainer
          activeLocTypes={activeLocTypes}
          updateActiveFilters={(filter) => updateActiveFilters(filter, true)}
        />
      )}

      <img src="statics/tittle_er.png" alt="Logo" id="logo" />
    </Box>
  );
}

function ToggleButton({ onClick, position, icon }) {
  return (
    <Button
      style={{ position: 'absolute', top: position, left: 10 }}
      variant="contained"
      onClick={onClick}
    >
      <img src={icon} alt="Toggle" />
    </Button>
  );
}

function FilterContainer({ activeFilters, updateActiveFilters }) {
  const filterOptions = [
    { filter: 'tresure', icon: 'icons/icon_tresure.png', label: 'Treasure' },
    { filter: 'teleport', icon: 'icons/icon_teleport.png', label: 'Teleport' },
    { filter: 'fishing', icon: 'icons/icon_fishing.png', label: 'Fishing' },
    { filter: 'zone', icon: 'icons/icon_zone.png', label: 'Zone' },
    { filter: 'training', icon: 'icons/icon_train.png', label: 'Training' },
  ];

  return (
    <Box className="filter-container">
      <Button
        className="filter-btn"
        data-filter="all"
        variant="contained"
        color="primary"
        onClick={() => updateActiveFilters('all')}
      >
        <img src="icons/icon_teleport.png" alt="All" /> Clear all marks
      </Button>
      {filterOptions.map((option) => (
        <FormControlLabel
          key={option.filter}
          control={
            <Checkbox
              onChange={() => updateActiveFilters(option.filter)}
              checked={activeFilters.includes(option.filter)}
            />
          }
          label={<img src={option.icon} alt={option.label} />}
        />
      ))}
    </Box>
  );
}

function NewFilterContainer({ activeLocTypes, updateActiveFilters }) {
  const filterButtons = [
    { filter: 'loc_type2', label: 'Sundale Valley' },
    { filter: 'loc_type5', label: 'Howling Gobi' },
    { filter: 'loc_type4', label: 'Edengate' },
    { filter: 'loc_type3', label: 'Ragon Snowy Peak' },
    { filter: 'loc_type6', label: 'Kepler Harbour' },
  ];

  return (
    <Box className="new-filter-container">
      {filterButtons.map((btn) => (
        <Button
          key={btn.filter}
          className={`filter-btn ${activeLocTypes.includes(btn.filter) ? 'active' : ''}`}
          variant="contained"
          color="primary"
          onClick={() => updateActiveFilters(btn.filter)}
        >
          {btn.label}
        </Button>
      ))}
    </Box>
  );
}

export default App;

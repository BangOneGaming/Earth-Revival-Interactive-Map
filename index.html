<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:image" content="https://th.bing.com/th/id/OIP.iOfUjHE3lrhx3xlVQdSrEwAAAA?rs=1&pid=ImgDetMain" />
    <title>Earth Revival Interactive Maps</title>
    <style>
        /* Style for the map container */
        #map {
            height: 100vh;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Container for filter buttons */
        .filter-container {
            position: absolute;
            top: 10px;
            left: 10px;
            /* 将 left 设为 10px，确保在所有设备上都位于屏幕左上角 */
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Style for the filter buttons */
        .filter-btn {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease;
            text-align: center;
            font-size: 16px;
        }

        .filter-btn:hover {
            background-color: #f0f0f0;
        }

        .filter-btn.active {
            background-color: #007bff;
            color: #fff;
        }

        .filter-btn img {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }

        @media (max-width: 600px) {
            .filter-container {
                flex-direction: row;
                top: auto;
                bottom: 10px;
                width: 100%;
                justify-content: space-around;
            }

            .filter-btn {
                flex: 1;
                margin: 0 5px;
                font-size: 14px;
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <!-- Filter buttons -->
    <div class="filter-container">
        <div class="filter-btn active" data-filter="all">
            <img src="icons/icon_teleport.png" alt="All"> All
        </div>
        <div class="filter-btn" data-filter="tresure">
            <img src="icons/icon_tresure.png" alt="Treasure"> Treasure
        </div>
        <div class="filter-btn" data-filter="teleport">
            <img src="icons/icon_teleport.png" alt="Teleport"> Teleport
        </div>
        <div class="filter-btn" data-filter="fishing">
            <img src="icons/icon_fishing.png" alt="Fishing"> Fishing
        </div>
        <div class="filter-btn" data-filter="zone">
            <img src="icons/icon_zone.png" alt="Zone"> Zone
        </div>
    </div>


    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg&callback=initMap"
        async defer></script>
    <script src="updated_output.js"></script>
    <script src="minimap_config.js"></script>
    <script>
        let activeFilters = [];
        let markers = [];
        function initMap() {
            var init_position = window.init_position;
            if (typeof init_position == 'undefined') {
                init_position = "56.871009248911655,-72.62568359375001";
            }
            var center_postion = init_position.split(",");
            // Initialize the map
            map = new google.maps.Map(document.getElementById('map'), {
                center: {
                    //lat:59.5,
                    lat: center_postion[0] * 1,
                    // lng:-78.8
                    lng: center_postion[1] * 1
                },
                zoom: 6,
                //zoom: that.deviceType != 'isPc'?6:4,
                streetViewControl: false,
                mapTypeControl: false,
                disableDefaultUI: true,
                noClear: true,
                backgroundColor: '#1E2026'
            });

            // Custom map type (if needed, replace with actual logic or remove if not used)
            var myMap = new google.maps.ImageMapType({
                getTileUrl: function (coord, zoom) {
                    var normalizedCoord = getNormalizedCoord(coord, zoom);
                    if (!normalizedCoord) {
                        return null;
                    }

                    var xy_deny = {
                        "zoom_4": [4, 4],
                        "zoom_5": [8, 9],
                        "zoom_6": [16, 19],
                        "zoom_7": [32, 39],
                        "zoom_8": [64, 79],
                        "zoom_9": [128, 159],
                        "zoom_10": [256, 219],
                        "zoom_11": [512, 639],
                        "zoom_12": [1024, 1279],
                        "zoom_13": [2048, 2559]
                    };
                    if (zoom < 4 || zoom > 9) {
                        return null;
                    }
                    var temp = xy_deny["zoom_" + zoom];
                    if ((temp[0] <= normalizedCoord.x && normalizedCoord.x <= temp[1]) &&
                        (temp[0] <= normalizedCoord.y && normalizedCoord.y <= temp[1])) {
                        return `statics/yuan_${zoom}_${normalizedCoord.x}_${normalizedCoord.y}.png`;
                    } else {
                        return null;
                    }
                },
                tileSize: new google.maps.Size(256, 256),
                maxZoom: 9,
                minZoom: 6,
                radius: 1738000,
                name: 'Default'
            });
            map.mapTypes.set('default', myMap);
            map.setMapTypeId('default');

            google.maps.event.addListener(map, 'zoom_changed', function () {
                if (map.zoom < 6) {
                    map.zoom = 6;
                }
            });

            var strictBounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(66, -89.4),
                new google.maps.LatLng(57, -67.40522460937501)
            );

            google.maps.event.addListener(map, 'dragend', function () {
                if (strictBounds.contains(map.getCenter())) return;

                var c = map.getCenter(),
                    x = c.lng(),
                    y = c.lat(),
                    maxX = strictBounds.getNorthEast().lng(),
                    maxY = strictBounds.getSouthWest().lat(),
                    minX = strictBounds.getSouthWest().lng(),
                    minY = strictBounds.getNorthEast().lat();

                if (x < minX) x = minX;
                if (x > maxX) x = maxX;
                if (y < minY) y = minY;
                if (y > maxY) y = maxY;

                map.setCenter(new google.maps.LatLng(y, x));
            });

            const infoWindow = new google.maps.InfoWindow();

            // Assume jsonData is defined elsewhere in your script
            for (const key in jsonData) {
                if (jsonData.hasOwnProperty(key)) {
                    const location = jsonData[key];
                    const latLng = {
                        lat: parseFloat(location.lat),
                        lng: parseFloat(location.lng)
                    };
                    let icon;
                    switch (location.category_id) {
                        case '7':
                            icon = 'icons/icon_train.png';
                            break;
                        case '2':
                            icon = 'icons/icon_tresure.png';
                            break;
                        case '1':
                            icon = 'icons/icon_teleport.png';
                            break;
                        case '3':
                            icon = 'icons/icon_zone.png';
                            break;
                        case '9':
                        case '10':
                        case '11':
                        case '12':
                        case '13':
                        case '14':
                            icon = 'icons/icon_fishing.png';
                            break;
                        default:
                            icon = 'icon_scenery.png';
                            break;
                    }
                    const marker = new google.maps.Marker({
                        position: latLng,
                        map: map,
                        icon: icon,
                        category: location.category_id,
                        draggable: false
                    });

                    marker.addListener('click', () => {
                        const latInt = Math.round(location.lat);
                        const lngInt = -Math.round(location.lng);
                        const coord = convertToRealCoordinates(latInt, lngInt);
                        const contentString = `
        <div style="padding: 12px; font-family: Arial, sans-serif; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); background-color: #f9f9f9;">
            <h3 style="margin-top: 0; margin-bottom: 8px; color: #007bff; font-size: 18px;">${location.en_name}</h3>
            <p style="margin-bottom: 8px; color: #555; font-size: 14px; line-height: 1.5;">${location.desc}</p>
        </div>
    `;
                        infoWindow.setContent(contentString);
                        infoWindow.open(map, marker);
                    });
                    // Store the marker for filtering
                    markers.push(marker);
                    // Store the marker for filtering
                    markers.push(marker);
                }
            }

            // Add event listeners to the filter buttons
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', () => {
                    // Toggle the active state
                    button.classList.toggle('active');

                    // Update the active filters
                    updateActiveFilters(button.getAttribute('data-filter'));

                    // Filter markers
                    filterMarkers();
                });
            });


            this.initMiniMap();
        }

        function updateActiveFilters(filter) {
            if (filter === 'all') {
                // If "All" is selected, clear other filters
                if (activeFilters.includes('all')) {
                    activeFilters = [];
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                } else {
                    activeFilters = ['all'];
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        if (btn.getAttribute('data-filter') !== 'all') {
                            btn.classList.remove('active');
                        }
                    });
                }

            } else {
                if (activeFilters.includes('all')) {
                    activeFilters = [];
                    document.querySelector('.filter-btn[data-filter="all"]').classList.remove('active');
                }

                const index = activeFilters.indexOf(filter);
                if (index > -1) {
                    activeFilters.splice(index, 1);
                } else {
                    activeFilters.push(filter);
                }

                if (activeFilters.length === 0) {
                    activeFilters.push('all');
                    document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
                }
            }
        }

        function filterMarkers() {
            markers.forEach(marker => {
                if (activeFilters.includes('all')) {
                    marker.setMap(map);
                } else if (activeFilters.includes('tresure') && marker.category === '2') {
                    marker.setMap(map);
                } else if (activeFilters.includes('teleport') && marker.category === '1') {
                    marker.setMap(map);
                } else if (activeFilters.includes('fishing') && ['9', '10', '11', '12', '13', '14'].includes(marker.category)) {
                    marker.setMap(map);
                } else if (activeFilters.includes('zone') && marker.category === '3') {
                    marker.setMap(map);
                } else {
                    marker.setMap(null);
                }
            });
        }

        // Helper function to normalize tile coordinates for custom map (if needed)
        function getNormalizedCoord(coord, zoom) {
            var y = coord.y;
            var x = coord.x;

            var tileRange = 1 << zoom;

            if (y < 0 || y >= tileRange) {
                return null;
            }
            if (x < 0 || x >= tileRange) {
                return null;
            }

            return { x: x, y: y };
        }

        function convertToRealCoordinates(lat, lng) {
            // 已知的两个点及其真实坐标
            const pointA = { lat: 63.171168582509964, lng: -81.67373672492919, x: 565, y: 994 };
            const pointB = { lat: 63.64373403289217, lng: -80.2736367391884, x: 319, y: 1156 };

            // 解构已知点的坐标和真实坐标
            const { lat: lat1, lng: lng1, x: x1, y: y1 } = pointA;
            const { lat: lat2, lng: lng2, x: x2, y: y2 } = pointB;

            // 计算纬度和经度的比例
            const latScale = (x2 - x1) / (lat2 - lat1);
            const lngScale = (y2 - y1) / (lng2 - lng1);

            // 计算新的真实坐标
            const x = x1 + (lat - lat1) * latScale;
            const y = y1 + (lng - lng1) * lngScale;

            // 返回计算出的真实坐标，四舍五入到最近的整数
            return { x: Math.round(x), y: Math.round(y) };
        }

        function initMiniMap() {

            var that = this;
            var changeWindow = null;
            var mapKey = "";
            var mapurl = "";
            this.mini_map_marker = {};
            function openChangeWindow(marker) {
                console.log("mini map = " + mapKey + " " + mapurl);
                var url = mapurl;
                var overlay = that.mini_map_marker[mapKey].historicalOverlay;

                // 检查 historicalOverlay 是否已经显示
                if (overlay.getMap()) {
                    // 如果已经显示，则隐藏
                    overlay.setMap(null);
                } else {
                    // 否则，更新 url 并显示
                    overlay.set("url", url);
                    overlay.setMap(that.map);
                }

                var contentStr = [];
                var info = marker.info;
            }
            for (var key in mini_map_type) {
                const key_cur = key;
                var info = mini_map_type[key_cur];
                var li_active = key_cur + '_default'
                var temp = li_active.split("_");
                if (typeof info['type'][temp[1]] == 'undefined') {
                    li_active = key_cur + '_default';
                    temp = li_active.split("_");
                }
                const url_cur = info['type'][temp[1]]['map_url'];
                console.log("mini map = " + key_cur);
                console.log(url_cur);
                var loc_position = info.loc_position.split(",");
                //显示标点
                var marker = new google.maps.Marker({
                    position: {
                        lat: loc_position[0] * 1,
                        lng: loc_position[1] * 1,
                    },
                    map: this.map,
                    icon: {
                        url: "icons/here.png",
                        scaledSize: new google.maps.Size(50, 50) // 将图标放大为 50x50 像素
                    }
                });
                marker.addListener('click', function () {
                    console.log(key_cur);
                    mapKey = key_cur;
                    mapurl = url_cur;
                    openChangeWindow(this)
                });



                //覆盖小地图显示
                var lg1 = info['map_position'][0].split(",");
                var lg2 = info['map_position'][1].split(",");
                var imageBounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(lg1[0] * 1, lg1[1] * 1),
                    new google.maps.LatLng(lg2[0] * 1, lg2[1] * 1)
                );

                var historicalOverlay = new google.maps.GroundOverlay(url_cur, imageBounds);
                //historicalOverlay.setMap(this.map);
                marker.li_active = li_active;
                marker.info = info;
                marker.historicalOverlay = historicalOverlay;
                marker.setMap(this.map);
                this.mini_map_marker[key_cur] = marker;
            }

        }
    </script>
</body>

</html>